<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gestión de Trabajos | Foto Castro</title>
    
    <!-- Fuentes de Google -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CSS personalizado -->
    <link rel="stylesheet" href="../css/styles.css">
    
    <style>
        .admin-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .admin-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            margin-left: 0.5rem;
        }
        
        .trabajo-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-completado { background: #dcfce7; color: #166534; }
        .status-en_proceso { background: #fef3c7; color: #92400e; }
        .status-pendiente { background: #f3f4f6; color: #374151; }
        
        .code-output {
            background: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>

<body class="admin-container">
    <!-- PANTALLA DE LOGIN -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center px-4">
        <div class="admin-card p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <span class="material-symbols-outlined text-6xl text-purple-600 mb-4 block">admin_panel_settings</span>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Panel Manual</h1>
                <p class="text-gray-600">Ingresa la contraseña para continuar</p>
            </div>
            
            <form id="login-form">
                <div class="form-group">
                    <label class="form-label">Contraseña</label>
                    <input type="password" id="password-input" class="form-input" placeholder="Ingresa tu contraseña" required autofocus>
                    <small class="text-gray-500">Misma contraseña del Admin Auto</small>
                </div>
                
                <button type="submit" class="btn-primary w-full">
                    <span class="material-symbols-outlined inline mr-2">lock_open</span>
                    Acceder al Panel
                </button>
                
                <div id="login-error" class="hidden mt-4 bg-red-50 border border-red-200 rounded-lg p-3">
                    <div class="flex items-center">
                        <span class="material-symbols-outlined text-red-600 mr-2">error</span>
                        <p class="text-red-800 text-sm">Contraseña incorrecta. Inténtalo nuevamente.</p>
                    </div>
                </div>
                
                <div class="mt-6 pt-4 border-t border-gray-200 text-center">
                    <p class="text-sm text-gray-600 mb-2">¿Prefieres el panel automático?</p>
                    <a href="admin-auto.html" class="text-sm text-green-600 hover:text-green-800">
                        Ir al Admin Auto
                    </a>
                </div>
            </form>
        </div>
    </div>
    
    <!-- PANEL PRINCIPAL (oculto inicialmente) -->
    <div id="admin-panel" class="hidden">
    <div class="container mx-auto px-4 py-8">
        
        <!-- HEADER -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">Panel de Administración</h1>
            <p class="text-white/80">Gestión de Trabajos - Foto Castro</p>
        </div>
        
        <!-- NAVEGACIÓN -->
        <div class="admin-card p-6 mb-8">
            <div class="flex flex-wrap gap-4 justify-center">
                <button onclick="mostrarSeccion('agregar')" class="btn-primary" id="btn-agregar">
                    <span class="material-symbols-outlined inline mr-2">add</span>
                    Agregar Trabajo
                </button>
                <button onclick="mostrarSeccion('listar')" class="btn-secondary" id="btn-listar">
                    <span class="material-symbols-outlined inline mr-2">list</span>
                    Ver Trabajos
                </button>
                <button onclick="mostrarSeccion('codigo')" class="btn-secondary" id="btn-codigo">
                    <span class="material-symbols-outlined inline mr-2">sync</span>
                    Actualizar Archivo
                </button>
            </div>
        </div>
        
        <!-- SECCIÓN: AGREGAR TRABAJO -->
        <div id="seccion-agregar" class="admin-card p-6 mb-8">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">
                <span class="material-symbols-outlined inline mr-2">add_circle</span>
                Agregar Nuevo Trabajo
            </h2>
            
            <form id="form-trabajo">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <!-- Palabra Clave -->
                    <div class="form-group">
                        <label class="form-label">Palabra Clave *</label>
                        <input type="text" id="palabra-clave" class="form-input" placeholder="ej: PEREZ2024" required>
                        <small class="text-gray-500">Sin espacios, solo letras y números</small>
                    </div>
                    
                    <!-- Nombre del Cliente -->
                    <div class="form-group">
                        <label class="form-label">Nombre del Cliente *</label>
                        <input type="text" id="cliente" class="form-input" placeholder="ej: Juan y María Pérez" required>
                    </div>
                    
                    <!-- Tipo de Sesión -->
                    <div class="form-group">
                        <label class="form-label">Tipo de Sesión *</label>
                        <select id="tipo" class="form-select" required>
                            <option value="">Seleccionar tipo</option>
                            <option value="Fotografía de bodas">Fotografía de bodas</option>
                            <option value="Fotografía de 15 años">Fotografía de 15 años</option>
                            <option value="Sesión newborn">Sesión newborn</option>
                            <option value="Fotografía de grado">Fotografía de grado</option>
                            <option value="Sesión de bebés">Sesión de bebés</option>
                            <option value="Sesión pre-mamá">Sesión pre-mamá</option>
                            <option value="Primera comunión">Primera comunión</option>
                            <option value="Confirmación">Confirmación</option>
                            <option value="Bautismo">Bautismo</option>
                            <option value="Evento corporativo">Evento corporativo</option>
                            <option value="Evento familiar">Evento familiar</option>
                            <option value="Foto estudio">Foto estudio</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    
                    <!-- Fecha de la Sesión -->
                    <div class="form-group">
                        <label class="form-label">Fecha de la Sesión *</label>
                        <input type="date" id="fecha" class="form-input" required>
                    </div>
                    
                    <!-- Estado -->
                    <div class="form-group">
                        <label class="form-label">Estado del Trabajo *</label>
                        <select id="estado" class="form-select" required>
                            <option value="pendiente">Pendiente</option>
                            <option value="en_proceso">En proceso</option>
                            <option value="completado">Completado</option>
                        </select>
                    </div>
                    
                    <!-- Progreso -->
                    <div class="form-group">
                        <label class="form-label">Progreso (%)</label>
                        <input type="number" id="progreso" class="form-input" min="0" max="100" value="0" placeholder="0-100">
                    </div>
                    
                    <!-- Fotos Total -->
                    <div class="form-group">
                        <label class="form-label">Total de Fotos</label>
                        <input type="number" id="fotos-total" class="form-input" min="1" value="50" placeholder="ej: 150">
                    </div>
                    
                    <!-- Fotos Editadas -->
                    <div class="form-group">
                        <label class="form-label">Fotos Editadas</label>
                        <input type="number" id="fotos-editadas" class="form-input" min="0" value="0" placeholder="ej: 75">
                    </div>
                    
                    <!-- Entrega Estimada -->
                    <div class="form-group">
                        <label class="form-label">Entrega Estimada</label>
                        <input type="date" id="entrega-estimada" class="form-input">
                    </div>
                    
                </div>
                
                <!-- Observaciones -->
                <div class="form-group">
                    <label class="form-label">Observaciones</label>
                    <textarea id="observaciones" class="form-textarea" rows="3" placeholder="Notas adicionales sobre el trabajo..."></textarea>
                </div>
                
                <!-- Botones -->
                <div class="flex gap-4 pt-4">
                    <button type="submit" class="btn-primary">
                        <span class="material-symbols-outlined inline mr-2">save</span>
                        Guardar Trabajo
                    </button>
                    <button type="button" onclick="limpiarFormulario()" class="btn-secondary">
                        <span class="material-symbols-outlined inline mr-2">refresh</span>
                        Limpiar
                    </button>
                </div>
            </form>
        </div>
        
        <!-- SECCIÓN: LISTAR TRABAJOS -->
        <div id="seccion-listar" class="admin-card p-6 mb-8 hidden">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">
                <span class="material-symbols-outlined inline mr-2">list</span>
                Trabajos Guardados
            </h2>
            <div id="lista-trabajos"></div>
        </div>
        
        <!-- SECCIÓN: ACTUALIZACIÓN AUTOMÁTICA -->
        <div id="seccion-codigo" class="admin-card p-6 mb-8 hidden">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">
                <span class="material-symbols-outlined inline mr-2">sync</span>
                Actualización Automática
            </h2>
            <p class="text-gray-600 mb-4">Haz clic para actualizar automáticamente el archivo verificar-trabajo.html con los nuevos trabajos:</p>
            
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                <div class="flex items-center">
                    <span class="material-symbols-outlined text-blue-600 mr-2">info</span>
                    <p class="text-blue-800 text-sm">
                        <strong>Actualización automática:</strong> El sistema modificará directamente el archivo sin necesidad de copiar código manualmente.
                    </p>
                </div>
            </div>
            
            <div class="flex gap-4">
                <button onclick="actualizarArchivoAutomatico()" class="btn-primary">
                    <span class="material-symbols-outlined inline mr-2">upload</span>
                    Actualizar Archivo Automáticamente
                </button>
                
                <button onclick="mostrarCodigo()" class="btn-secondary">
                    <span class="material-symbols-outlined inline mr-2">code</span>
                    Ver Código (Manual)
                </button>
            </div>
            
            <!-- Área para mostrar código (oculta por defecto) -->
            <div id="codigo-manual" class="hidden mt-4">
                <p class="text-gray-600 mb-2">Código generado (para copia manual si es necesario):</p>
                <div class="code-output" id="codigo-generado"></div>
                <button onclick="copiarCodigo()" class="btn-secondary mt-2">
                    <span class="material-symbols-outlined inline mr-2">content_copy</span>
                    Copiar Código
                </button>
            </div>
            
            <!-- Área de estado -->
            <div id="estado-actualizacion" class="mt-4"></div>
        </div>
        
        <!-- BOTÓN DE REGRESO Y CERRAR SESIÓN -->
        <div class="text-center">
            <div class="flex gap-4 justify-center">
                <a href="../index.html" class="btn-secondary">
                    <span class="material-symbols-outlined inline mr-2">arrow_back</span>
                    Volver al Sitio Principal
                </a>
                <button onclick="cerrarSesion()" class="btn-secondary">
                    <span class="material-symbols-outlined inline mr-2">logout</span>
                    Cerrar Sesión
                </button>
            </div>
        </div>
    </div>
    </div> <!-- Cierre del admin-panel -->
    
    <script>
        // Configuración de seguridad (compartida con admin-auto)
        const ADMIN_CONFIG = {
            defaultPassword: 'fotocastro2024',
            sessionTimeout: 30 * 60 * 1000, // 30 minutos
            storageKey: 'fotocastro_admin_session',
            passwordKey: 'fotocastro_admin_password'
        };
        
        // Variables globales
        let sessionTimer;
        
        // Base de datos temporal para trabajos
        let trabajosGuardados = [];
        
        // Elementos del DOM
        const loginScreen = document.getElementById('login-screen');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form');
        const passwordInput = document.getElementById('password-input');
        const loginError = document.getElementById('login-error');
        const formTrabajo = document.getElementById('form-trabajo');
        const listaTrabajos = document.getElementById('lista-trabajos');
        const codigoGenerado = document.getElementById('codigo-generado');
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            verificarSesion();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            // Manejar envío del formulario de login
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                verificarPassword();
            });
            
            // Manejar Enter en el campo de contraseña
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    verificarPassword();
                }
            });
            
            // Configurar el formulario de trabajo solo si está disponible
            if (formTrabajo) {
                formTrabajo.addEventListener('submit', function(e) {
                    e.preventDefault();
                    agregarTrabajo();
                });
            }
            
            // Auto-logout por inactividad
            setupInactivityTimer();
        }
        
        function verificarSesion() {
            const session = localStorage.getItem(ADMIN_CONFIG.storageKey);
            
            if (session) {
                try {
                    const sessionData = JSON.parse(session);
                    const now = new Date().getTime();
                    
                    // Verificar si la sesión no ha expirado
                    if (now - sessionData.timestamp < ADMIN_CONFIG.sessionTimeout) {
                        mostrarPanel();
                        return;
                    }
                } catch (error) {
                    console.error('Error verificando sesión:', error);
                }
            }
            
            // Si llegamos aquí, mostrar login
            mostrarLogin();
        }
        
        function verificarPassword() {
            const password = passwordInput.value;
            const storedPassword = localStorage.getItem(ADMIN_CONFIG.passwordKey) || ADMIN_CONFIG.defaultPassword;
            
            if (password === storedPassword) {
                // Contraseña correcta
                const sessionData = {
                    timestamp: new Date().getTime(),
                    authenticated: true
                };
                
                localStorage.setItem(ADMIN_CONFIG.storageKey, JSON.stringify(sessionData));
                mostrarPanel();
                ocultarError();
            } else {
                // Contraseña incorrecta
                mostrarError();
                passwordInput.value = '';
                passwordInput.focus();
            }
        }
        
        function mostrarLogin() {
            loginScreen.classList.remove('hidden');
            adminPanel.classList.add('hidden');
            passwordInput.focus();
        }
        
        function mostrarPanel() {
            loginScreen.classList.add('hidden');
            adminPanel.classList.remove('hidden');
            
            // Cargar datos del panel
            cargarTrabajos();
            mostrarSeccion('agregar');
            
            // Iniciar timer de sesión
            iniciarTimerSesion();
        }
        
        function mostrarError() {
            loginError.classList.remove('hidden');
            setTimeout(() => {
                loginError.classList.add('hidden');
            }, 5000);
        }
        
        function ocultarError() {
            loginError.classList.add('hidden');
        }
        
        function cerrarSesion() {
            if (confirm('¿Estás seguro de que quieres cerrar la sesión?')) {
                localStorage.removeItem(ADMIN_CONFIG.storageKey);
                clearTimeout(sessionTimer);
                mostrarLogin();
            }
        }
        
        function iniciarTimerSesion() {
            clearTimeout(sessionTimer);
            
            sessionTimer = setTimeout(() => {
                alert('Tu sesión ha expirado por inactividad. Serás redirigido al login.');
                cerrarSesion();
            }, ADMIN_CONFIG.sessionTimeout);
        }
        
        function setupInactivityTimer() {
            // Eventos que resetean el timer de inactividad
            const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
            
            events.forEach(event => {
                document.addEventListener(event, () => {
                    if (!adminPanel.classList.contains('hidden')) {
                        iniciarTimerSesion();
                    }
                }, { passive: true });
            });
        }
        
        function agregarTrabajo() {
            // Obtener datos del formulario
            const palabraClave = document.getElementById('palabra-clave').value.toUpperCase().trim();
            const cliente = document.getElementById('cliente').value.trim();
            const tipo = document.getElementById('tipo').value;
            const fecha = document.getElementById('fecha').value;
            const estado = document.getElementById('estado').value;
            const progreso = parseInt(document.getElementById('progreso').value) || 0;
            const fotosTotal = parseInt(document.getElementById('fotos-total').value) || 50;
            const fotosEditadas = parseInt(document.getElementById('fotos-editadas').value) || 0;
            const entregaEstimada = document.getElementById('entrega-estimada').value;
            const observaciones = document.getElementById('observaciones').value.trim();
            
            // Validaciones
            if (!palabraClave || !cliente || !tipo || !fecha) {
                alert('Por favor completa todos los campos obligatorios (*)');
                return;
            }
            
            // Verificar que la palabra clave no exista
            if (trabajosGuardados.find(t => t.palabraClave === palabraClave)) {
                alert('Esta palabra clave ya existe. Por favor usa una diferente.');
                return;
            }
            
            // Formatear fecha
            const fechaFormateada = formatearFecha(fecha);
            const entregaFormateada = entregaEstimada ? formatearFecha(entregaEstimada) : 'Por definir';
            
            // Crear objeto de trabajo
            const nuevoTrabajo = {
                palabraClave,
                cliente,
                tipo,
                fecha: fechaFormateada,
                estado,
                progreso,
                fotos_total: fotosTotal,
                fotos_editadas: fotosEditadas,
                entrega_estimada: entregaFormateada,
                observaciones: observaciones || 'Sin observaciones adicionales.'
            };
            
            // Agregar a la lista
            trabajosGuardados.push(nuevoTrabajo);
            
            // Guardar en localStorage
            guardarTrabajos();
            
            // Limpiar formulario
            limpiarFormulario();
            
            // Mostrar confirmación
            alert(`Trabajo "${palabraClave}" agregado exitosamente!`);
            
            // Actualizar vista de lista si está visible
            if (!document.getElementById('seccion-listar').classList.contains('hidden')) {
                mostrarListaTrabajos();
            }
        }
        
        function formatearFecha(fecha) {
            const opciones = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(fecha + 'T00:00:00').toLocaleDateString('es-ES', opciones);
        }
        
        function limpiarFormulario() {
            formTrabajo.reset();
            document.getElementById('progreso').value = 0;
            document.getElementById('fotos-total').value = 50;
            document.getElementById('fotos-editadas').value = 0;
        }
        
        function mostrarSeccion(seccion) {
            // Ocultar todas las secciones
            document.getElementById('seccion-agregar').classList.add('hidden');
            document.getElementById('seccion-listar').classList.add('hidden');
            document.getElementById('seccion-codigo').classList.add('hidden');
            
            // Resetear botones
            document.querySelectorAll('.btn-primary, .btn-secondary').forEach(btn => {
                btn.className = btn.className.replace('btn-primary', 'btn-secondary');
            });
            
            // Mostrar sección seleccionada
            document.getElementById(`seccion-${seccion}`).classList.remove('hidden');
            document.getElementById(`btn-${seccion}`).className = document.getElementById(`btn-${seccion}`).className.replace('btn-secondary', 'btn-primary');
            
            // Cargar contenido específico
            if (seccion === 'listar') {
                mostrarListaTrabajos();
            } else if (seccion === 'codigo') {
                // Limpiar estado anterior
                document.getElementById('estado-actualizacion').innerHTML = '';
                document.getElementById('codigo-manual').classList.add('hidden');
            }
        }
        
        function mostrarListaTrabajos() {
            if (trabajosGuardados.length === 0) {
                listaTrabajos.innerHTML = '<p class="text-gray-500 text-center py-8">No hay trabajos guardados aún.</p>';
                return;
            }
            
            let html = '';
            trabajosGuardados.forEach((trabajo, index) => {
                html += `
                    <div class="trabajo-item">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="font-bold text-lg">${trabajo.cliente}</h3>
                                <p class="text-gray-600">${trabajo.tipo} - ${trabajo.fecha}</p>
                                <p class="text-sm text-gray-500">Palabra clave: <code class="bg-gray-100 px-2 py-1 rounded">${trabajo.palabraClave}</code></p>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="status-badge status-${trabajo.estado}">
                                    ${trabajo.estado === 'completado' ? 'Completado' : 
                                      trabajo.estado === 'en_proceso' ? 'En proceso' : 'Pendiente'}
                                </span>
                                <button onclick="eliminarTrabajo(${index})" class="text-red-500 hover:text-red-700">
                                    <span class="material-symbols-outlined">delete</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-3">
                            <div>
                                <span class="text-gray-500">Progreso:</span>
                                <div class="font-semibold">${trabajo.progreso}%</div>
                            </div>
                            <div>
                                <span class="text-gray-500">Fotos:</span>
                                <div class="font-semibold">${trabajo.fotos_editadas}/${trabajo.fotos_total}</div>
                            </div>
                            <div>
                                <span class="text-gray-500">Entrega:</span>
                                <div class="font-semibold">${trabajo.entrega_estimada}</div>
                            </div>
                            <div>
                                <button onclick="editarTrabajo(${index})" class="text-blue-500 hover:text-blue-700 text-sm">
                                    <span class="material-symbols-outlined inline">edit</span> Editar
                                </button>
                            </div>
                        </div>
                        
                        ${trabajo.observaciones !== 'Sin observaciones adicionales.' ? 
                            `<div class="text-sm text-gray-600 italic">"${trabajo.observaciones}"</div>` : ''}
                    </div>
                `;
            });
            
            listaTrabajos.innerHTML = html;
        }
        
        function eliminarTrabajo(index) {
            if (confirm('¿Estás seguro de que quieres eliminar este trabajo?')) {
                trabajosGuardados.splice(index, 1);
                guardarTrabajos();
                mostrarListaTrabajos();
            }
        }
        
        function editarTrabajo(index) {
            const trabajo = trabajosGuardados[index];
            
            // Llenar el formulario con los datos
            document.getElementById('palabra-clave').value = trabajo.palabraClave;
            document.getElementById('cliente').value = trabajo.cliente;
            document.getElementById('tipo').value = trabajo.tipo;
            document.getElementById('estado').value = trabajo.estado;
            document.getElementById('progreso').value = trabajo.progreso;
            document.getElementById('fotos-total').value = trabajo.fotos_total;
            document.getElementById('fotos-editadas').value = trabajo.fotos_editadas;
            document.getElementById('observaciones').value = trabajo.observaciones === 'Sin observaciones adicionales.' ? '' : trabajo.observaciones;
            
            // Eliminar el trabajo actual para que se pueda "re-agregar"
            trabajosGuardados.splice(index, 1);
            guardarTrabajos();
            
            // Ir a la sección de agregar
            mostrarSeccion('agregar');
            
            alert('Trabajo cargado para edición. Modifica los datos y guarda nuevamente.');
        }
        
        function generarCodigo() {
            if (trabajosGuardados.length === 0) {
                document.getElementById('codigo-generado').textContent = '// No hay trabajos para generar código\nconst trabajosDatabase = {};';
                return '';
            }
            
            let codigo = 'const trabajosDatabase = {\n';
            
            trabajosGuardados.forEach((trabajo, index) => {
                codigo += `    '${trabajo.palabraClave}': {\n`;
                codigo += `        cliente: '${trabajo.cliente}',\n`;
                codigo += `        tipo: '${trabajo.tipo}',\n`;
                codigo += `        fecha: '${trabajo.fecha}',\n`;
                codigo += `        estado: '${trabajo.estado}',\n`;
                codigo += `        progreso: ${trabajo.progreso},\n`;
                codigo += `        fotos_total: ${trabajo.fotos_total},\n`;
                codigo += `        fotos_editadas: ${trabajo.fotos_editadas},\n`;
                codigo += `        entrega_estimada: '${trabajo.entrega_estimada}',\n`;
                codigo += `        observaciones: '${trabajo.observaciones}'\n`;
                codigo += `    }${index < trabajosGuardados.length - 1 ? ',' : ''}\n\n`;
            });
            
            codigo += '};';
            
            document.getElementById('codigo-generado').textContent = codigo;
            return codigo;
        }
        
        function mostrarCodigo() {
            document.getElementById('codigo-manual').classList.remove('hidden');
            generarCodigo();
        }
        
        async function actualizarArchivoAutomatico() {
            const estadoDiv = document.getElementById('estado-actualizacion');
            
            try {
                // Mostrar estado de carga
                estadoDiv.innerHTML = `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <span class="material-symbols-outlined text-blue-600 mr-2 animate-spin">refresh</span>
                            <p class="text-blue-800">Actualizando archivo verificar-trabajo.html...</p>
                        </div>
                    </div>
                `;
                
                // Leer el archivo actual
                const response = await fetch('../pages/verificar-trabajo.html');
                const contenidoActual = await response.text();
                
                // Generar el nuevo código
                const nuevoCodigo = generarCodigo();
                
                if (!nuevoCodigo || nuevoCodigo.includes('No hay trabajos')) {
                    throw new Error('No hay trabajos para actualizar');
                }
                
                // Encontrar y reemplazar la sección trabajosDatabase
                const inicioPattern = /const trabajosDatabase = \{/;
                const finPattern = /\};.*?(?=\n.*?function|$)/s;
                
                const inicioMatch = contenidoActual.search(inicioPattern);
                if (inicioMatch === -1) {
                    throw new Error('No se pudo encontrar la sección trabajosDatabase en el archivo');
                }
                
                // Encontrar el final de la base de datos
                const despuesDelInicio = contenidoActual.substring(inicioMatch);
                let nivelLlaves = 0;
                let finIndex = -1;
                
                for (let i = 0; i < despuesDelInicio.length; i++) {
                    if (despuesDelInicio[i] === '{') nivelLlaves++;
                    if (despuesDelInicio[i] === '}') {
                        nivelLlaves--;
                        if (nivelLlaves === 0) {
                            finIndex = inicioMatch + i + 1;
                            break;
                        }
                    }
                }
                
                if (finIndex === -1) {
                    throw new Error('No se pudo encontrar el final de trabajosDatabase');
                }
                
                // Crear el nuevo contenido
                const antesDeDB = contenidoActual.substring(0, inicioMatch);
                const despuesDeDB = contenidoActual.substring(finIndex);
                const nuevoContenido = antesDeDB + nuevoCodigo + despuesDeDB;
                
                // Crear blob y descargar
                const blob = new Blob([nuevoContenido], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'verificar-trabajo.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Mostrar éxito
                estadoDiv.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <span class="material-symbols-outlined text-green-600 mr-2">check_circle</span>
                            <div>
                                <p class="text-green-800 font-semibold">¡Archivo actualizado exitosamente!</p>
                                <p class="text-green-700 text-sm">Se ha descargado el archivo verificar-trabajo.html actualizado. 
                                Reemplaza el archivo en la carpeta pages/</p>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                // Mostrar error
                estadoDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <span class="material-symbols-outlined text-red-600 mr-2">error</span>
                            <div>
                                <p class="text-red-800 font-semibold">Error al actualizar el archivo</p>
                                <p class="text-red-700 text-sm">${error.message}</p>
                                <p class="text-red-600 text-xs mt-2">Usa la opción "Ver Código (Manual)" como alternativa.</p>
                            </div>
                        </div>
                    </div>
                `;
                
                // Mostrar código manual como respaldo
                mostrarCodigo();
            }
        }
        
        function copiarCodigo() {
            const codigo = codigoGenerado.textContent;
            navigator.clipboard.writeText(codigo).then(() => {
                alert('Código copiado al portapapeles!');
            }).catch(() => {
                alert('Error al copiar. Selecciona el texto manualmente.');
            });
        }
        
        function guardarTrabajos() {
            localStorage.setItem('fotocastro_trabajos', JSON.stringify(trabajosGuardados));
        }
        
        function cargarTrabajos() {
            const trabajosGuardadosStr = localStorage.getItem('fotocastro_trabajos');
            if (trabajosGuardadosStr) {
                trabajosGuardados = JSON.parse(trabajosGuardadosStr);
            }
        }
    </script>
</body>
</html>
